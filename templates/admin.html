<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 问卷星自动填答系统</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
        }
        .sidebar {
            background-color: #2c3e50;
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            width: 250px;
            left: 0;
            top: 0;
        }
        .sidebar a {
            color: #ecf0f1;
            text-decoration: none;
            display: block;
            padding: 12px 20px;
            border-left: 3px solid transparent;
            transition: all 0.3s;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #34495e;
            border-left-color: #3498db;
            color: #3498db;
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .header {
            background-color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: none;
            border-radius: 8px;
        }
        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.85rem;
        }
        .badge {
            padding: 4px 8px;
        }
        .modal-header {
            background-color: #3498db;
            color: white;
        }
        .form-label {
            font-weight: 500;
            color: #2c3e50;
        }
        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }
        .stats-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid #34495e; margin-bottom: 20px;">
            <h5 style="color: #ecf0f1; margin: 0;">管理后台</h5>
            <small style="color: #95a5a6;">问卷星系统</small>
        </div>
        <a href="#" class="nav-link active" onclick="showSection('users')">用户管理</a>
        <a href="#" class="nav-link" onclick="showSection('recharge')">充值审核</a>
        <a href="#" class="nav-link" onclick="showSection('stats')">统计信息</a>
        <a href="#" class="nav-link" onclick="logout()">登出</a>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 顶部栏 -->
        <div class="header">
            <h3 style="margin: 0;">问卷星管理系统</h3>
            <div>
                <span id="adminName" style="margin-right: 20px;"></span>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()">登出</button>
            </div>
        </div>

        <!-- 用户管理部分 -->
        <div id="usersSection">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="showAddUserModal()">添加用户</button>
                <input type="text" id="searchInput" class="form-control" placeholder="搜索用户（邮箱/用户名）" style="width: 300px; display: inline-block; margin-left: 10px;">
            </div>

            <div class="table-container">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>邮箱</th>
                            <th>用户名</th>
                            <th>角色</th>
                            <th>积分</th>
                            <th>最后签到</th>
                            <th>注册时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="usersTable">
                        <tr><td colspan="8" class="text-center text-muted">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 充值审核部分 -->
        <div id="rechargeSection" style="display: none;">
            <div style="margin-bottom: 20px;">
                <select id="rechargeStatusFilter" class="form-select" style="width: 200px; display: inline-block;" onchange="loadRechargeRequests()">
                    <option value="pending">待审核</option>
                    <option value="approved">已批准</option>
                    <option value="rejected">已拒绝</option>
                    <option value="all">全部</option>
                </select>
                <button class="btn btn-outline-primary ms-2" onclick="loadRechargeRequests()">刷新</button>
                <span id="pendingCount" class="badge bg-warning ms-2" style="font-size: 1rem;"></span>
            </div>

            <div class="table-container">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>用户</th>
                            <th>邮箱</th>
                            <th>申请积分</th>
                            <th>备注</th>
                            <th>状态</th>
                            <th>申请时间</th>
                            <th>处理时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rechargeTable">
                        <tr><td colspan="9" class="text-center text-muted">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 统计信息部分 -->
        <div id="statsSection" style="display: none;">
            <div class="row">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-label">总用户数</div>
                        <div class="stats-value" id="totalUsers">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-label">管理员数</div>
                        <div class="stats-value" id="adminCount">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-label">总积分</div>
                        <div class="stats-value" id="totalPoints">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-label">平均积分</div>
                        <div class="stats-value" id="avgPoints">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑用户模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑用户</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">用户ID</label>
                        <input type="text" id="editUserId" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">邮箱</label>
                        <input type="email" id="editEmail" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" id="editUsername" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">角色</label>
                        <select id="editRole" class="form-select">
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">积分</label>
                        <input type="number" id="editPoints" class="form-control" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserChanges()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加用户</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">邮箱</label>
                        <input type="email" id="newEmail" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" id="newUsername" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码</label>
                        <input type="password" id="newPassword" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">手机号</label>
                        <input type="tel" id="newPhone" class="form-control" placeholder="可选">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">初始积分</label>
                        <input type="number" id="newPoints" class="form-control" value="0" min="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addNewUser()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let allUsers = [];
        let editModal, addModal;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
            addModal = new bootstrap.Modal(document.getElementById('addUserModal'));
            
            // 检查权限
            checkAdmin();
            
            // 加载用户列表
            loadUsers();
            
            // 搜索功能
            document.getElementById('searchInput').addEventListener('input', filterUsers);
        });

        // 检查是否为管理员
        async function checkAdmin() {
            try {
                const res = await fetch('/user/profile');
                if (res.status === 401) {
                    // 清除缓存并重定向
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/login.html';
                    return;
                }
                const data = await res.json();
                if (data.status === 'success' && data.role === 'admin') {
                    document.getElementById('adminName').textContent = `欢迎，${data.data.username}`;
                } else {
                    // 无权限，清除缓存并重定向
                    localStorage.clear();
                    sessionStorage.clear();
                    alert('无权限访问');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login.html';
            }
        }

        // 加载用户列表
        async function loadUsers() {
            try {
                const res = await fetch('/admin/users');
                const data = await res.json();
                if (data.status === 'success') {
                    allUsers = data.data;
                    renderUsers(allUsers);
                    updateStats();
                }
            } catch (error) {
                console.error('加载用户失败:', error);
            }
        }

        // 渲染用户表格
        function renderUsers(users) {
            const tbody = document.getElementById('usersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暂无用户</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.username}</td>
                    <td>
                        <span class="badge ${user.role === 'admin' ? 'bg-danger' : 'bg-secondary'}">
                            ${user.role === 'admin' ? '管理员' : '普通用户'}
                        </span>
                    </td>
                    <td>${user.points}</td>
                    <td>${user.last_signin || '-'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString('zh-CN')}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="editUser(${user.id})">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        // 搜索过滤
        function filterUsers() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.email.toLowerCase().includes(keyword) || 
                user.username.toLowerCase().includes(keyword)
            );
            renderUsers(filtered);
        }

        // 编辑用户
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editRole').value = user.role;
            document.getElementById('editPoints').value = user.points;
            
            editModal.show();
        }

        // 保存用户修改
        async function saveUserChanges() {
            const userId = parseInt(document.getElementById('editUserId').value);
            const role = document.getElementById('editRole').value;
            const points = parseInt(document.getElementById('editPoints').value);

            try {
                // 更新角色
                if (role !== allUsers.find(u => u.id === userId).role) {
                    await fetch(`/admin/user/${userId}/role`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({role})
                    });
                }

                // 更新积分
                if (points !== allUsers.find(u => u.id === userId).points) {
                    await fetch(`/admin/user/${userId}/points`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({points})
                    });
                }

                alert('修改成功');
                editModal.hide();
                loadUsers();
            } catch (error) {
                alert('修改失败: ' + error.message);
            }
        }

        // 删除用户
        async function deleteUser(userId) {
            if (!confirm('确定要删除该用户吗？')) return;

            try {
                const res = await fetch(`/admin/user/${userId}`, {method: 'DELETE'});
                const data = await res.json();
                if (data.status === 'success') {
                    alert('删除成功');
                    loadUsers();
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 显示添加用户模态框
        function showAddUserModal() {
            document.getElementById('newEmail').value = '';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newPhone').value = '';
            document.getElementById('newPoints').value = '0';
            addModal.show();
        }

        // 添加新用户
        async function addNewUser() {
            const email = document.getElementById('newEmail').value.trim();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const phone = document.getElementById('newPhone').value.trim();
            const points = parseInt(document.getElementById('newPoints').value);

            if (!email || !username || !password) {
                alert('请填写邮箱、用户名、密码');
                return;
            }

            try {
                // 通过管理员接口添加用户
                let res = await fetch('/admin/add-user', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, username, password, phone})
                });
                let data = await res.json();
                
                if (data.status !== 'success') {
                    alert('添加失败: ' + data.message);
                    return;
                }

                // 获取新用户ID并设置积分
                res = await fetch('/admin/users');
                data = await res.json();
                const newUser = data.data.find(u => u.email === email);
                
                if (newUser && points > 0) {
                    await fetch(`/admin/user/${newUser.id}/points`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({points})
                    });
                }

                alert('用户添加成功');
                addModal.hide();
                loadUsers();
            } catch (error) {
                alert('添加失败: ' + error.message);
            }
        }

        // 更新统计信息
        function updateStats() {
            const totalUsers = allUsers.length;
            const adminCount = allUsers.filter(u => u.role === 'admin').length;
            const totalPoints = allUsers.reduce((sum, u) => sum + u.points, 0);
            const avgPoints = totalUsers > 0 ? Math.round(totalPoints / totalUsers) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('adminCount').textContent = adminCount;
            document.getElementById('totalPoints').textContent = totalPoints;
            document.getElementById('avgPoints').textContent = avgPoints;
        }

        // 显示/隐藏部分
        function showSection(section) {
            document.getElementById('usersSection').style.display = section === 'users' ? 'block' : 'none';
            document.getElementById('rechargeSection').style.display = section === 'recharge' ? 'block' : 'none';
            document.getElementById('statsSection').style.display = section === 'stats' ? 'block' : 'none';
            
            // 更新导航栏
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            
            // 加载充值申请
            if (section === 'recharge') {
                loadRechargeRequests();
            }
        }

        // 加载充值申请列表
        async function loadRechargeRequests() {
            const status = document.getElementById('rechargeStatusFilter').value;
            try {
                const res = await fetch(`/user/recharge_requests?status=${status}`);
                const data = await res.json();
                if (data.status === 'success') {
                    renderRechargeRequests(data.data);
                    
                    // 更新待审核数量
                    if (status === 'pending') {
                        document.getElementById('pendingCount').textContent = `待审核: ${data.data.length}`;
                    } else {
                        // 单独获取待审核数量
                        const pendingRes = await fetch('/user/recharge_requests?status=pending');
                        const pendingData = await pendingRes.json();
                        if (pendingData.status === 'success') {
                            document.getElementById('pendingCount').textContent = `待审核: ${pendingData.data.length}`;
                        }
                    }
                }
            } catch (error) {
                console.error('加载充值申请失败:', error);
            }
        }

        // 渲染充值申请表格
        function renderRechargeRequests(requests) {
            const tbody = document.getElementById('rechargeTable');
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无申请</td></tr>';
                return;
            }

            const statusMap = {
                'pending': '<span class="badge bg-warning">待审核</span>',
                'approved': '<span class="badge bg-success">已批准</span>',
                'rejected': '<span class="badge bg-danger">已拒绝</span>'
            };
            
            const paymentMap = {
                'alipay': '<span class="badge bg-primary">支付宝</span>',
                'wechat': '<span class="badge bg-success">微信</span>'
            };

            tbody.innerHTML = requests.map(req => `
                <tr>
                    <td>${req.id}</td>
                    <td>${req.username}</td>
                    <td>${req.email}</td>
                    <td><strong>${req.amount}</strong></td>
                    <td>${paymentMap[req.payment_method] || req.payment_method || '-'}</td>
                    <td>${statusMap[req.status] || req.status}</td>
                    <td>${formatDateTime(req.created_at)}</td>
                    <td>${req.processed_at ? formatDateTime(req.processed_at) : '-'}</td>
                    <td>
                        ${req.status === 'pending' ? `
                            <button class="btn btn-sm btn-success" onclick="processRecharge(${req.id}, 'approve')">批准</button>
                            <button class="btn btn-sm btn-danger" onclick="processRecharge(${req.id}, 'reject')">拒绝</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        // 处理充值申请
        async function processRecharge(requestId, action) {
            const actionText = action === 'approve' ? '批准' : '拒绝';
            if (!confirm(`确定要${actionText}该充值申请吗？`)) return;

            try {
                const res = await fetch(`/user/recharge_requests/${requestId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action})
                });
                const data = await res.json();
                if (data.status === 'success') {
                    alert(data.message);
                    loadRechargeRequests();
                    loadUsers(); // 刷新用户列表以更新积分
                } else {
                    alert('操作失败: ' + data.message);
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 格式化日期时间
        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 登出
        async function logout() {
            // 清除所有本地存储和缓存
            localStorage.clear();
            sessionStorage.clear();
            
            await fetch('/user/logout', {method: 'POST'});
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
